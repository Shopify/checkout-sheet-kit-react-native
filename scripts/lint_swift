#!/bin/bash

DIR=modules/@shopify/checkout-sheet-kit
MODE="${1:-check}"

# Validate the mode
if [[ "$MODE" != "check" && "$MODE" != "fix" ]]; then
    echo "‚ùå Invalid mode: $MODE"
    echo "Usage: $0 [check|fix]"
    echo "  check: Run linters in check mode (default)"
    echo "  fix:   Run linters in fix mode to auto-fix issues"
    exit 1
fi

# Function to provide installation instructions
print_install_instructions() {
    echo "üîß FIX:"
    echo "   Shopify employee? Run 'dev up'"
    echo "   Not a Shopify employee? Install via homebrew:"
    echo "     - SwiftLint: 'brew install swiftlint' / https://github.com/realm/SwiftLint"
    echo "     - SwiftFormat: 'brew install swiftformat' / https://github.com/nicklockwood/SwiftFormat"
}

# Check for SwiftLint
if ! which swiftlint >/dev/null; then
    echo "‚ö†Ô∏è WARN: SwiftLint not installed"
    print_install_instructions
    exit 1
fi

# Check for SwiftFormat
if ! which swiftformat >/dev/null; then
    echo "‚ö†Ô∏è WARN: SwiftFormat not installed"
    print_install_instructions
    exit 1
fi

# Run SwiftLint
if [[ "$MODE" == "check" ]]; then
    echo "üîÑ Running SwiftLint in check mode..."
    swiftlint lint --strict $DIR --config .swiftlint.yml
    LINT_STATUS=$?
else
    echo "üîÑ Running SwiftLint in fix mode..."
    swiftlint lint --fix $DIR --config .swiftlint.yml
    LINT_STATUS=$?
fi
echo "SwiftLint exit status: $LINT_STATUS"

# Run SwiftFormat
if [[ "$MODE" == "check" ]]; then
    echo "üîÑ Running SwiftFormat in check mode..."
    swiftformat $DIR --lint --config .swiftformat
    FORMAT_STATUS=$?
else
    echo "üîÑ Running SwiftFormat in fix mode..."
    swiftformat $DIR --config .swiftformat
    FORMAT_STATUS=$?
fi
echo "SwiftFormat exit status: $FORMAT_STATUS"

# Function to print error messages for linting issues
print_linting_error() {
    local tool_name=$1
    echo "‚ùå $tool_name detected issues that need to be fixed."
    echo "üîß How to fix:"
    echo "   Shopify employee? Run 'dev fix' or 'dev check' to see detailed output"
    echo "   Not a Shopify employee? Run './scripts/lint_swift fix' to auto-fix issues"
    if [[ "$tool_name" == "SwiftLint" ]]; then
        echo "   Then fix any remaining non-autofixable issues manually"
    fi
}

# Handle exit codes for check mode
if [[ "$MODE" == "check" ]]; then
    if [ $LINT_STATUS -ne 0 ]; then
        print_linting_error "SwiftLint"
        exit 1
    fi

    if [ $FORMAT_STATUS -ne 0 ]; then
        print_linting_error "SwiftFormat"
        exit 1
    fi

    echo "‚úÖ All linting checks passed!"
else
    echo "‚úÖ Linting fixes applied!"
fi
